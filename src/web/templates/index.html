<!doctype html style="height:90%;">

<head>
<title>RecEventos</title>
<link rel="stylesheet" type="text/css" href="static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="static/style.css">
<script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
</head>

<body style="height:90%;">

	<div class="row">
		<div class="container" style="margin-left:auto; margin-right:auto;">
			<div class="span8">
				<blockquote class="pull-right" >
					<h1> RecEventos</h1>
					<small>Events recommendation &copy FRH-Analytics <cite title="Universidade Federal de Campina Grande">UFCG</cite>/<cite title="Hewlett-Packard">HP</cite></small>
				</blockquote>
			</div>
			<div class="span2" style="height:10%;">
				<button id="venues_button" style="padding-top:10px; margin-top:2px;" class="btn btn-small btn-danger btn-block disabled" type="button">Venues</button>
				<button id="users_button" style="padding-bottom:10px; margin-bottom:2px;" class="btn btn-small btn-success btn-block disabled" type="button" onclick="" >Users</button>
			</div>
		</div>
	</div>
	<div class="row" style="height:90%;">
<!--		<div class="container"> -->
			<div id="map_canvas" style="height:90%;"></div>
<!--		</div> -->
	</div>


	<div id="venue_events" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="venue_events_label" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
			<h3 id="venue_events_label">Venue Events</h3>
		</div>
		<div id="venue_events_body" class="modal-body">
			<img src="static/ajax-loader.gif"></img>
		</div>
		<div class="modal-footer">
			<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Close</button>
		</div>
	</div>

	<div id="loading" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div id="loading_modal_body" class="modal-body">
			<h2>Loading...</h2>
			<img src="static/ajax-loader.gif"></img>
		</div>
	</div>

    </body>
	<script src="static/jquery-1.9.1.min.js" language="javascript" type="text/javascript"></script>
	<script src="static/bootstrap/js/bootstrap.js" language="javascript" type="text/javascript"></script>
	<script language="javascript">


    var directionDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;

    var venue_markers = new Array();
    var user_markers = new Array();

    function mapinitialize() {
        directionsDisplay = new google.maps.DirectionsRenderer();
        var cg = new google.maps.LatLng(-7.242598, -35.892334);
        var myOptions = {
            zoom:16,
            mapTypeId:google.maps.MapTypeId.ROADMAP,
            center:cg
        }
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        directionsDisplay.setMap(map);
    }

    function calcRoute(r) {

        var waypts = [];

        start = new google.maps.LatLng(r.src[0], r.src[1]);
        end = new google.maps.LatLng(r.dst[0], r.dst[1]);
        var request = {
            origin:start,
            destination:end,
            waypoints:waypts,
            optimizeWaypoints:true,
            travelMode:google.maps.DirectionsTravelMode.DRIVING
        };
        directionsService.route(request, function (response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
                var route = response.routes[0];
            }
        });
	}

	function start(){
		mapinitialize();
		pinVenuesInMap(null, null, null);
		map.panTo(venue_markers[Math.floor((Math.random()*venue_markers.length+1))].getPosition());
		$('#users_button').removeClass("disabled").attr("onclick", "showUsersView();");
	}

	function removeVenueMarkers(){
		for (i in venue_markers){
			venue_markers[i].setMap(null);
		}
		venue_markers.length = 0;
	}

	function removeAllMarkers(){
		removeVenueMarkers();
		for (i in user_markers ){
			user_markers[i].setMap(null);
		}
		user_markers.length = 0;
	}

	function sortbyLatLng(a, b){
		if (a.lat < b.lat){
			return -1;
		}
		else if (a.lat == b.lat){
			if (a.lon < b.lon){
				return -1;
			}
			else if (a.lon == b.lon){
				return 0;
			}
			else{
				return -1;
			}
		}
		else{
			return 1;
		}
	}

	function pinVenuesInMap(venues, in_respect_to_user, events_user_have){

		if ( venues == null ){
			venues = new Array();

			{% for venue in venues %}

				venues.push( { 'id' : {{venue.id}}, 'name' : "{{venue.name}}", 'lat' : {{venue.lat}}, 'lon' : {{venue.lon}} });

			{% endfor %}

		}

		venues.sort(sortbyLatLng);

		console.log("About to pin "+venues.length+" venues in map!");

		var c_lat = -1, c_long = -1;
		var close_venues = new Array();

		for (var i=0; i<venues.length; i++ ){

			if ( c_lat != -1 && c_long != -1 ){
				if (Math.abs(c_lat - venues[i].lat) > 0.000001 && Math.abs(c_long - venues[i].lon) > 0.000001){
					close_venues = new Array();
				}
			}
			c_long = parseFloat(venues[i].lon);
			c_lat = parseFloat(venues[i].lat);

			var venue_marker = new google.maps.Marker({position : new google.maps.LatLng(venues[i].lat, venues[i].lon),
						map : map,
						title : venues[i].name,
						icon : 'static/venue-marker.png' });
			venue_markers.push(venue_marker);
			var showVenueEventClosure = showVenueEvents(close_venues, in_respect_to_user, events_user_have);
			google.maps.event.addListener(venue_marker, 'click', showVenueEventClosure);

			close_venues.push(venues[i]);
		}
	}

	function showVenueEvents(close_venues, in_respect_to_user, events_user_have){
		function showModal(){
			var url = "/" + close_venues[0].id;
			for ( var i=1; i<close_venues.length; i++ ){
				url += "&" + close_venues[i].id;
			}
			if ( in_respect_to_user ){
				url += "/user_id/" + in_respect_to_user;
			}
			if ( events_user_have && events_user_have != 0 ){
				url += "/" + events_user_have[0].id;
				for ( var i=1; i<events_user_have.length; i++ ){
					url += "&" + events_user_have[i].id;
				}
			}
			$("#venue_events_body").html("<img src='static/ajax-loader.gif'></img>");
			$("#venue_events_body").load('venue_events'+url, function(data){
				for ( var j=0; j<close_venues.length; j++ ){
					var vid = close_venues[j].id;
					var vname = close_venues[j].name;
					$("#venue_"+vid).html(vname);
				};
			});

			$("#venue_events").modal('show');
		}
		return showModal;
	}

	var users_events = null;

	function doPinUsersInMap(users, users_events){

		panToMe = null;

		removeAllMarkers();
		for (var i=0; i<users.length; i++ ){

			var user_marker = new google.maps.Marker({position : new google.maps.LatLng(users[i].lat, users[i].lon),
						map : map,
						title : users[i].name,
						icon : 'static/user-marker.png' });
			user_markers.push(user_marker);

			events = users_events[users[i].id];
			if ( events == undefined ){
				events = new Array();
			}
			else{
				panToMe = new Array(users[i].lat, users[i].lon);
			}

			var showUserEventClosure = showUserEvents(events, users[i].id);
			google.maps.event.addListener(user_marker, 'click', showUserEventClosure);
		}

		$('#venues_button').removeClass("disabled").attr("onclick", "showVenuesView();");
//		$('#loading').modal('hide');

		if ( panToMe ){
			map.panTo(new google.maps.LatLng(panToMe[0], panToMe[1]));
		}

	}

	function pinUsersInMap(){

		var users = new Array();

		{% for user in users %}

			users.push({ 'id' : {{user.id}}, 'name' : "{{user.name}}", 'lat' : {{user.lat}}, 'lon' : {{user.lon}} });

		{% endfor %}

		users.sort(sortbyLatLng);

		if ( users_events == null ){

			$.get("users_events", function(data){
				users_events = JSON.parse(data);
				doPinUsersInMap(users, users_events);
			});
		}
		else{
			doPinUsersInMap(users, users_events);
		}
	}

	function showUserEvents(events, user_id){


		var venues = new Array();

		for ( var i=0; i<events.length; i++ ){
			var filterThis = false;
			for ( var j=0; j<venues.length; j++ ){
				if ( venues[j].id == events[i].venue_id ){
					filterThis = true;
					break;
				}
			}
			if ( filterThis ){
				continue;
			}
			venues.push( { 'id' : events[i].venue_id, 'name' : events[i].venue_name, 'lat' : events[i].lat, 'lon' : events[i].lon } );
		}
		function pinUserVenuesInMap(){
			window.alert("will pin all "+ venues.length +" events of user "+user_id);
			removeVenueMarkers();
			pinVenuesInMap(venues, user_id, events);
		}
		return pinUserVenuesInMap;
	}

	function showUsersView(){
		$('#users_button').addClass("disabled").attr("onclick", "");
/*		$('#loading').modal({
			keyboard : false,
			backdrop : "static",
			show : true
		});*/
		pinUsersInMap();
	}

	function showVenuesView(){
		$('#venues_button').addClass("disabled").attr("onclick", "");
//		$('#loading').modal({
//			keyboard : false,
//			backdrop : "static",
//			show : true
//		});
		removeAllMarkers();
		pinVenuesInMap(null, null, null);
		$('#users_button').removeClass("disabled").attr("onclick", "showUsersView();");
//		$('#loading').modal('hide');
	}

	$(document).ready(start());

	</script>
</html>
