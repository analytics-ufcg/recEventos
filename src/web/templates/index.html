<!doctype html style="height:90%;">

<head>
<title>RecEventos MapDisplay</title>
<link rel="stylesheet" type="text/css" href="static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="static/style.css">
<script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
</head>

<body style="height:90%;">

	<div class="row">
		<div class="container" style="margin-left:auto; margin-right:auto;">
			<div class="span8">
				<blockquote class="pull-right" >
					<h1> RecEventos Data</h1>
					<small>Visualizing data from <cite title="Meetup.com">Meetup.com</cite> - &copy FRH Analytics UFCG</small>
				</blockquote>
			</div>
			<div class="span2" style="height:10%;">
				<button id="venues_button" style="padding-top:10px; margin-top:2px;" class="btn btn-small btn-danger btn-block disabled" type="button">Venues</button>
				<button id="users_button" style="padding-bottom:10px; margin-bottom:2px;" class="btn btn-small btn-success btn-block disabled" type="button" onclick="" >Users</button>
			</div>
		</div>
	</div>
	<div class="row" style="height:90%;">
<!--		<div class="container"> -->
			<div id="map_canvas" style="height:90%;"></div>
<!--		</div> -->
	</div>


	<div id="venue_events" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="venue_events_label" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
			<h3 id="venue_events_label">Venue Events</h3>
		</div>
		<div id="venue_events_body" class="modal-body">
			<p>Loading...</p>
		</div>
		<div class="modal-footer">
			<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Close</button>
		</div>
	</div>

    </body>
	<script src="static/jquery-1.9.1.min.js" language="javascript" type="text/javascript"></script>
	<script src="static/bootstrap/js/bootstrap.js" language="javascript" type="text/javascript"></script>
	<script language="javascript">


    var directionDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;

    var venue_markers = new Array();
    var venue_marker_ids = new Array();

    function mapinitialize() {
        directionsDisplay = new google.maps.DirectionsRenderer();
        var cg = new google.maps.LatLng(-7.242598, -35.892334);
        var myOptions = {
            zoom:16,
            mapTypeId:google.maps.MapTypeId.ROADMAP,
            center:cg
        }
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        directionsDisplay.setMap(map);
    }

    function calcRoute(r) {

        var waypts = [];

        start = new google.maps.LatLng(r.src[0], r.src[1]);
        end = new google.maps.LatLng(r.dst[0], r.dst[1]);
        var request = {
            origin:start,
            destination:end,
            waypoints:waypts,
            optimizeWaypoints:true,
            travelMode:google.maps.DirectionsTravelMode.DRIVING
        };
        directionsService.route(request, function (response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
                var route = response.routes[0];
            }
        });
	}

	function start(){
		mapinitialize();
		pinVenuesInMap();
	}

	function removeMarkers(){
		for (i in venue_markers){
			venue_markers[i].setMap(null);
		}
		venue_markers.length = 0;
	}

	function sortbyLatLng(a, b){
		if (a.lat < b.lat){
			return -1;
		}
		else if (a.lat == b.lat){
			if (a.lon < b.lon){
				return -1;
			}
			else if (a.lon == b.lon){
				return 0;
			}
			else{
				return -1;
			}
		}
		else{
			return 1;
		}
	}

	function pinVenuesInMap(){
		
		var venues = new Array();

		{% for venue in venues %}

			venues.push( { 'id' : {{venue.id}}, 'lat' : {{venue.lat}}, 'lon' : {{venue.lon}} });

		{% endfor %}

		venues.sort(sortbyLatLng);

		var c_lat = -1, c_long = -1;
		var close_venues = new Array();

		for (var i=0; i<venues.length; i++ ){

			if ( c_lat != -1 && c_long != -1 ){
				if (Math.abs(c_lat - venues[i].lat) > 0.000001 && Math.abs(c_long - venues[i].lon) > 0.000001){
					close_venues = new Array();
				}
			}
			c_long = parseInt(venues[i].lon);
			c_lat = parseFloat(venues[i].lat);

			var venue_marker = new google.maps.Marker({position : new google.maps.LatLng(venues[i].lat, venues[i].lon),
						map : map,
						icon : 'static/venue-marker.png' });
			venue_markers.push(venue_marker);
			venue_marker_ids[venue_marker] = venues[i].id;
			var showVenueEvent = showVenueEvents(venues[i].id, close_venues);
			google.maps.event.addListener(venue_marker, 'click', showVenueEvent);

			close_venues.push(venues[i].id);

			if ( i == venues.length-1 ){
				map.panTo(new google.maps.LatLng(venues[i].lat, venues[i].lon));
			}
		}
		$('#users_button').removeClass("disabled").attr("onclick", "showUsersView();");
	}

	function showVenueEvents(venue_id, close_venues){
		function showModal(){
			console.log("showing events of venue with id ="+venue_id);
			$("#venue_events_body").load('venue_events/'+venue_id);
			$("#venue_events").modal('show');
			if (close_venues.length != 0){
				console.log("there are also these venues in the same spot:");
			}
			for ( var i=0; i<close_venues.length; i++ ){
				console.log("venue with id = "+close_venues[i]);
			}
		}
		return showModal;
	}
	
	function showUsersView(){
		$('#users_button').addClass("disabled").attr("onclick", "");
		$('#venues_button').removeClass("disabled").attr("onclick", "showVenuesView();");
		removeMarkers();
	}

	function showVenuesView(){
		$('#venues_button').addClass("disabled").attr("onclick", "");
		$('#users_button').removeClass("disabled").attr("onclick", "showUsersView();");
		removeMarkers();
		pinVenuesInMap();
	}

	$(document).ready(start());

	</script>
</html>
