<!doctype html style="height:90%;">

<head>
<title>RecEventos</title>
<link rel="stylesheet" type="text/css" href="static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="static/style.css">
<script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
</head>

<body style="height:90%;">

	<div class="span3" style="margin-left:5px;">
		<ul class="nav nav-list" style="height: 48%;">
			<li class="nav-header label label-info">Cities</li>
			<li class="divider"></li>
			<li>
				<ul id="cities-list" class="well nav nav-list" style="height: 87%; overflow-y:scroll;">
					{% for city in cities %}
					{% if city == "Arlington" %}
					<li id="city_{{city|replace(' ','_')}}" class="active"><a href="#" onclick="changeCity('{{city}}')"><i class="icon-home"></i>{{city}}</a></li>
					{% else %}
					<li id="city_{{city|replace(' ','_')}}"><a href="#" onclick="changeCity('{{city}}')"><i class="icon-home"></i>{{city}}</a></li>
					{% endif %}
					{% endfor %}
				</ul>
			</li>
		</ul>
		<ul class="nav nav-list" style="height: 45%; margin-top:50px;">
			<li id="user-list-header" class="nav-header label label-info">Users at Arlington</li>
			<li class="divider"></li>
			<li>
				<ul id="user-list" class="well nav nav-list" style="height: 87%; overflow-y:scroll;">
				</ul>
			</li>
		</ul>
	</div>
	<div class="span12" style="width:80%;">
		<div class="row">
			<div style="padding-top:10px; margin-top:2px;">
				<div class="span4">
					<blockquote class="pull-right">
						<h1> RecEventos</h1>
						<small>Events recommendation &copy FRH-Analytics <cite title="Universidade Federal de Campina Grande">UFCG</cite>/<cite title="Hewlett-Packard">HP</cite></small>
					</blockquote>
				</div>
				<div class="row span9">
					<div class="span4">
						<span class="label label-inverse">Current city:</span>
						<button id="cities_button" class="btn btn-large btn-inverse btn-block" type="button"> </button>
					</div>
					<div class="span4">
						<span class="label label-inverse">Current technique:</span>
						<button id="algs_button" class="btn btn-large btn-inverse btn-block" data-toggle="dropdown" type="button">None</button>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div id="map_canvas" style="height:86%; width:100%;"></div>
		</div>
	</div>

	<div id="event_details" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="event_details_label" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
			<h3 id="event_details_label">Event Details</h3>
		</div>
		<div id="event_details_body" class="modal-body">
			<img src="static/ajax-loader.gif"></img>
		</div>
		<div class="modal-footer">
			<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Close</button>
		</div>
	</div>

    </body>
	<script src="static/jquery-1.9.1.min.js" language="javascript" type="text/javascript"></script>
	<script src="static/bootstrap/js/bootstrap.js" language="javascript" type="text/javascript"></script>
	<script src="static/jquery.localscroll-1.2.7-min.js" language="javascript" type="text/javascript"></script>
	<script src="static/jquery.scrollTo-1.4.3.1-min.js" language="javascript" type="text/javascript"></script>
	<script language="javascript">
	
    var directionDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;

    var event_markers = new Array();
    var user_markers = new Array();
    var id_to_user_marker = {};
    var user_event_markers = new Array();

    var current_city = null;
    var current_user = null;
    var city_events = {};
    var city_members = {};

    function mapinitialize() {
    	directionsDisplay = new google.maps.DirectionsRenderer();
	var cg = new google.maps.LatLng(-7.242598, -35.892334);
	
	var styles = [
	  {
	    stylers: [
	      { hue: "#00ffe6" },
	      { saturation: -20 }
	    ]
	  },{
	    featureType: "road",
	    elementType: "geometry",
	    stylers: [
	      { lightness: 100 },
	      { visibility: "simplified" }
	    ]
	  },{
	    featureType: "road",
	    elementType: "labels",
	    stylers: [
	      { visibility: "off" }
	    ]
	  }
	];

        var myOptions = {
            zoom:11,
            mapTypeId:google.maps.MapTypeId.ROADMAP,
	    center:cg,
	    styles:styles
        }
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	directionsDisplay.setMap(map);
    }

    function calcRoute(r) {

        var waypts = [];

        start = new google.maps.LatLng(r.src[0], r.src[1]);
        end = new google.maps.LatLng(r.dst[0], r.dst[1]);
        var request = {
            origin:start,
            destination:end,
            waypoints:waypts,
            optimizeWaypoints:true,
            travelMode:google.maps.DirectionsTravelMode.DRIVING
        };
        directionsService.route(request, function (response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
                var route = response.routes[0];
            }
        });
	}

	function start(){
		mapinitialize();

		$("#user-list-header").html("Users at Arlington");
		current_city = "Arlington";
		$("#cities_button").html("Arlington");

		city_events[current_city] = [];
		{% for event in events %}
		city_events[current_city].push({ 'id' : "{{event.id}}", 'lat' : {{event.lat}}, 'lon' : {{event.lon}}, 'name' : "{{event.name}}", 'venue_name' : "{{event.venue_name}}", 'venue_city' : "{{event.venue_city}}", 'time' : "{{event.time}}" });
		{% endfor %}

		var user_list = "";

		city_members[current_city] = [];
		{% for user in users %}
		city_members[current_city].push({ 'id' : "{{user.id}}", 'lat' : {{user.lat}}, 'lon' : {{user.lon}}, 'name' : "{{user.name}}", 'events' : "{{user.events}}".split(","), 'city' : "{{user.city}}" });
		user_list += "<li id='user-list-item_{{user.id}}'><a  name='user-list-item_{{user.id}}' href='#'user-list-item_{{user.id}}' onclick='chooseUserById({{user.id}})'><i class='icon-user'></i>{{user.name}}</a></li>";
		{% endfor %}

		pinUsersInMap();
		if ( user_markers.length != 0 ){
			map.panTo(user_markers[Math.floor((Math.random()*user_markers.length))].marker.getPosition());
		}

		$("#user-list").html(user_list);
	}

	function changeCity(city){

		console.log("From city "+current_city+" to city "+city);
		$("#user-list-header").html("Users at "+city);

		$("#city_"+city.replace(" ", "_")).addClass("active");
		if ( current_city != null && current_city != "" && current_city != city ){
			$("#city_"+current_city.replace(" ", "_")).removeClass("active");
		}

		current_city = city;
		$("#cities_button").html(city);
		if ( city_events[current_city] ){
			removeAllMarkers();
			pinUsersInMap();
			if ( user_markers.length != 0 ){
				map.panTo(user_markers[Math.floor((Math.random()*user_markers.length))].marker.getPosition());
			}
			var user_list = "";
			for ( i in city_members[current_city] ){
				user_list += "<li id=\"user-list-item_" + city_members[current_city][i].id + "\"><a  name=\"user-list-item_" + city_members[current_city][i].id + "\"  href='#user-list-item_" + city_members[current_city][i].id + "' onclick='chooseUserById("+ city_members[current_city][i].id +")'><i class='icon-user'></i>" +city_members[current_city][i].name+"</a></li>";
			}
			$("#user-list").html(user_list);
		}
		else{
			$.get("load_city/"+city.replace(" ", "_"), function(data){

				data = JSON.parse(data);

				city_events[current_city] = [];
				for ( var i=0; i<data.events.length; i++){
					city_events[current_city].push({ 'id' : data.events[i].id, 'lat' : data.events[i].lat, 'lon' : data.events[i].lon, 'name' : data.events[i].name, 'venue_name' : data.events[i].venue_name, 'venue_city' : data.events[i].venue_city });
				};

				var user_list = "";
				city_members[current_city] = [];
				for ( var i=0; i<data.users.length; i++){
					city_members[current_city].push({ 'id' : data.users[i].id, 'lat' : data.users[i].lat, 'lon' : data.users[i].lon, 'name' : data.users[i].name, 'events' : data.users[i].events.split(","), 'city' : data.users[i].city });
					user_list += "<li id=\"user-list-item_" + city_members[current_city][i].id + "\" ><a  name=\"user-list-item_" + city_members[current_city][i].id + "\"  href='#user-list-item_" + city_members[current_city][i].id + "' onclick='chooseUserById("+ city_members[current_city][i].id +")'><i class='icon-user'></i>"+city_members[current_city][i].name+"</a></li>";
				};

				removeAllMarkers();
				pinUsersInMap();
				if ( user_markers.length != 0 ){
					map.panTo(user_markers[Math.floor((Math.random()*user_markers.length))].marker.getPosition());
				}
				$("#user-list").html(user_list);
			});
		}

		current_user = null;

	}

	function removeEventMarkers(){
		for (i in event_markers){
			event_markers[i].marker.setMap(null);
		}
		event_markers.length = 0;
	}

	function removeUserMarkers(){
		for (i in user_markers ){
			user_markers[i].marker.setMap(null);
		}
		user_markers.length = 0;
		id_to_user_marker = {};
	}

	function removeAllMarkers(){
		removeEventMarkers();
		removeUserMarkers();
	}

	function sortbyLatLng(a, b){
		if (a.lat < b.lat){
			return -1;
		}
		else if (a.lat == b.lat){
			if (a.lon < b.lon){
				return -1;
			}
			else if (a.lon == b.lon){
				return 0;
			}
			else{
				return -1;
			}
		}
		else{
			return 1;
		}
	}

	function chooseUserById(user_id){
		for ( i in city_members[current_city] ){
			if ( city_members[current_city][i].id == user_id ){
				var doIt = chooseUser(city_members[current_city][i]);
				doIt();
				break;
			}
		}
	}

	function chooseUser(user){

		console.log("binding function of user "+user.name+" ("+user.id+")");

		function doChooseAndPinEvents(){

			console.log("calling function of user "+user.name+" ("+user.id+")");

			if ( current_user != null && current_user.id != user.id ){
				$("#user-list-item_"+current_user.id).removeClass("active");
				user_markers[id_to_user_marker[current_user.id]].marker.setIcon('static/user-pin.png');
				user_markers[id_to_user_marker[current_user.id]].marker.setZIndex(0);
			}

			$("#user-list-item_"+user.id).addClass("active");
			user_markers[id_to_user_marker[user.id]].marker.setIcon('static/chosen-user-pin.png');
			user_markers[id_to_user_marker[user.id]].marker.setZIndex(100);
			window.location = "#user-list-item_"+user.id;

			current_user = user;

			pinUserEventsInMap(user);

		}
		return doChooseAndPinEvents;
	}

	function pinUsersInMap(){

		var users = city_members[current_city];
		users.sort(sortbyLatLng);

		var c_lat = -1, c_long = -1;
		var close_users = new Array();

		for (var i=0; i<users.length; i++ ){

			if ( c_lat != -1 && c_long != -1 ){
				if (Math.abs(c_lat - users[i].lat) > 0.000001 && Math.abs(c_long - users[i].lon) > 0.000001){
					close_users = new Array();
				}
			}
			c_long = parseFloat(users[i].lon);
			c_lat = parseFloat(users[i].lat);

			var user_marker = new google.maps.Marker({position : new google.maps.LatLng(users[i].lat, users[i].lon),
						map : map,
						title : users[i].name,
						icon : 'static/user-pin.png',
						shadow: 'static/shadow-user-pin.png',
						draggable : true,
						zIndex : 0	});
			user_markers.push({ 'marker' : user_marker, 'user' : users[i] });
			id_to_user_marker[users[i].id] = i;
			var chooseUserClosure = chooseUser(users[i]);
			google.maps.event.addListener(user_marker, 'click', chooseUserClosure);
			close_users.push(users[i]);
		}
	}

	function pinUserEventsInMap(user){

		removeEventMarkers();

		var events = city_events[current_city];
		var user_events = user.events;
		events.sort(sortbyLatLng);

		var c_lat = -1, c_long = -1;
		var close_events = new Array();

		for (var i=0; i<events.length; i++ ){

			for (var j=0; j<user_events.length; j++ ){
				if ( user_events[j] == events[i].id ){


					if ( c_lat != -1 && c_long != -1 ){
						if (Math.abs(c_lat - events[i].lat) > 0.000001 && Math.abs(c_long - events[i].lon) > 0.000001){
							close_events = new Array();
						}
					}
					c_long = parseFloat(events[i].lon);
					c_lat = parseFloat(events[i].lat);


					var event_status = getEventStatus(events[i], user_events);
					var status_icon = determineIcon(event_status);
					var event_details = showDetails(user, events[i], event_status);
					
					var event_marker = new google.maps.Marker({position : new google.maps.LatLng(events[i].lat, events[i].lon),
								map : map,
								title : events[i].name + " at " + events[i].venue_name + ", " + events[i].venue_city,
								icon : status_icon,
								shadow : 'static/shadow-event-pin.png',
								draggable : true,
								zIndex : 200	});
					event_markers.push({ 'marker' : event_marker, 'event' : events[i] });
					google.maps.event.addListener(event_marker, 'click', event_details);
					close_events.push(events[i]);

					break;
				}
			}
		}
	}

	function determineIcon(status){
		if ( status == "ok" ){
			return 'static/event-pin.png';
		}
	}

	function getEventStatus(event, user_events){
		return "ok";
	}

	function showDetails(user, event, status){
		function doShowDetails(){

			$("#event_details_body").html("<img src='static/ajax-loader.gif'></img>");
			$("#event_details").modal('show');

			var content = "<p><span class='label label-info'>"+user.name+"</span> from <span class='label label-success'>"+user.city+"</span> went to </p><p>this event <span class='label label-inverse'>\""+event.name+"\"</span></p><p>at <span class='label label-inverse'>"+event.venue_name+"</span>, <span class='label label-success'>"+event.venue_city+"</span></p><p> on <span class='label label-warning'>"+event.time+"</span>.</p>";
			$("#event_details_body").html(content);

		}
		return doShowDetails;
	}

	$(document).ready(function(){
		$("#user-list").localScroll({duration:800});
		start();	
	});
	
	
	</script>
</html>
